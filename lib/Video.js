"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_get=function(e,t,a){for(var r=!0;r;){var i=e,l=t,s=a;o=u=n=void 0,r=!1;var o=Object.getOwnPropertyDescriptor(i,l);if(void 0!==o){if("value"in o)return o.value;var n=o.get;return void 0===n?void 0:n.call(s)}var u=Object.getPrototypeOf(i);if(null===u)return void 0;e=u,t=l,a=s,r=!0}},_react=require("react"),_react2=_interopRequireDefault(_react),_reactDom=require("react-dom"),_reactDom2=_interopRequireDefault(_reactDom),_path=require("path"),_path2=_interopRequireDefault(_path),_utilsDateTimeJs=require("./utils/dateTime.js"),videoEvents=["play","pause","playing","abort","progress","ratechange","canplay","canplaythrough","durationchange","emptied","ended","loadeddata","loadedmetadata","loadstart","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","error","encrypted","mozaudioavailable","interruptbegin","interruptend"],Video=function(e){function t(e,a){var r=this;_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,e,a),this.api={};var i=["togglePlay","setTime","fullscreen","volume"];i.forEach(function(e){r["_"+e]=r.api[e]=r["_"+e].bind(r)});var l=["metaDataLoaded","timeupdate","durationchange","progress"];l.forEach(function(e){return r["_"+e]=r["_"+e].bind(r)})}return _inherits(t,e),_createClass(t,[{key:"componentDidMount",value:function(){this.$wraper=_reactDom2["default"].findDOMNode(this);var e=this.$video=this.api.$video=_reactDom2["default"].findDOMNode(this.refs.video);e.addEventListener("loadedmetadata",this._metaDataLoaded),e.addEventListener("progress",this._progress),this.props.autoPlay&&!this.seekbarUpdateTimer&&this.seekbarUpdateInterval()}},{key:"_metaDataLoaded",value:function(e){this.props.metaDataLoaded&&"function"==typeof this.props.metaDataLoaded&&this.props.metaDataLoaded(this.api),this.$seekbarWraper=_reactDom2["default"].findDOMNode(this.refs.seekbarWraper),this.setState({duration:_utilsDateTimeJs.formatTime(this.$video.duration)})}},{key:"seekbarUpdateInterval",value:function(){this.seekbarUpdateTimer=setInterval(this._timeupdate,80)}},{key:"_setTime",value:function(e,t){if(!(t&&e>100)){var a=t?e*this.$video.duration/100:e;this.$video.fastSeek?this.$video.fastSeek(a):this.$video.currentTime=a,this.setState({seekProgress:e})}}},{key:"_timeupdate",value:function(e){var t=this.$video.currentTime/this.$video.duration*100,a={seekProgress:t,currentTime:_utilsDateTimeJs.formatTime(this.$video.currentTime)};this.$video.currentTime>=this.$video.duration&&(a.isPlaying=!1),this.setState(a)}},{key:"_durationchange",value:function(){}},{key:"_progress",value:function(e){for(var t=this.$video.buffered,a=0,r=0;r<t.length;r++)a+=t.end(r)-t.start(r);this.setState({loadedProgress:a/this.$video.duration*100})}},{key:"_togglePlay",value:function(){this.seekbarUpdateTimer||this.seekbarUpdateInterval(),this.state.isPlaying?(this.$video.pause(),this.setState({isPlaying:!1})):(this.$video.currentTime>=this.$video.duration&&(this.$video.currentTime=0),this.$video.play(),this.setState({isPlaying:!0}))}},{key:"_fullscreen",value:function(e){for(var t=["requestFullScreen","mozRequestFullScreen","webkitRequestFullscreen","msRequestFullscreen"],a=0;a<t.length;a++)if(this.$video[t[a]])return this.$video[t[a]]()}},{key:"_volume",value:function(e){0>=e&&(e=0),e>1&&(e=1),this.$video.volume=e;var t={volume:e,isMuted:.05>=e?!0:!1};this.setState(t)}},{key:"_setSubtitle",value:function(e){this.$video.textTracks[this.state.activeSubtitle]&&(this.$video.textTracks[this.state.activeSubtitle].mode="disabled"),this.$video.textTracks[e].mode="showing",this.setState({activeSubtitle:e})}},{key:"$getSubtitleTracksMenu",value:function(){var e=this,t=[];if(!this.$video||this.$video.textTracks.length<=0)return t;for(var a=function(a){var r=e.$video.textTracks[a];t.push(_react2["default"].createElement("li",{key:a},_react2["default"].createElement("button",{onClick:function(t){return e._setSubtitle(a)}},r.label)))},r=0;r<this.$video.textTracks.length;r++)a(r);return this.subTitleMenu=_react2["default"].createElement("span",{className:"r5-subtitle"},_react2["default"].createElement("button",null,this.icons.subtitles),_react2["default"].createElement("ul",{className:"r5-subtitle-menu"},t)),this.subTitleMenu}},{key:"$getSubtitleTracks",value:function(e){if(!Array.isArray(e))return"";for(var t=[],a=0;a<e.length;a++){var r=e[a];t.push(_react2["default"].createElement("track",{src:r.src,kind:"subtitles",srcLang:r.lang,label:r.label,key:a}))}return t}},{key:"$getSource",value:function(e){if(!Array.isArray(e))return[];for(var t=[],a=0;a<e.length;a++){var r=e[a],i=_path2["default"].extname(r).substr(1);t.push(_react2["default"].createElement("source",{src:r,type:"video/"+i,key:a}))}return t}},{key:"render",value:function(){var e=this,t=this.props,a=t.subtitles,r=t.loop,i=t.autoPlay,l=t.poster,s=t.preload,o=t.sources,n=t.controlPanelStyle,u=t.autoHideControls,c={loop:r,autoPlay:i,poster:l,preload:s},d={},h={},v=this.$video||{},p=this.props.width||v.videoWidth||v.clientWidth,f=this.props.height||v.videoHeight||v.clientHeight;c.width=p,c.height=f,d.width=p+"px",d.height=h.height=f+"px","fixed"==this.props.controlPanelStyle&&(d.height=f+50+"px");var m="r5-controls r5-controls--"+n+" "+(u?"r5-auto-hide":"")+" ";return this.props.controls||(m="r5-controls-hidden"),_react2["default"].createElement("div",{className:"r5-wraper",style:d},_react2["default"].createElement("video",_extends({ref:"video"},c),this.$getSource(o),a&&a.length>0?this.$getSubtitleTracks(a):""),_react2["default"].createElement("div",{className:"r5-overlay",onClick:this._togglePlay},!this.$video||this.$video.currentTime<=0?this.icons.playCircle:""),_react2["default"].createElement("div",{className:"r5-content",style:h},this.props.children),_react2["default"].createElement("div",{className:m},_react2["default"].createElement("div",{className:"r5-seekbar-wraper",ref:"seekbarWraper"},_react2["default"].createElement("div",{className:"r5-seekbar-loaded",ref:"seekbar",style:{width:this.state.loadedProgress+"%"}}),_react2["default"].createElement("div",{className:"r5-seekbar",ref:"loadedbar",style:{width:this.state.seekProgress+"%"}}),_react2["default"].createElement("input",{type:"range",min:"0.0",max:"100.0",step:"0.5",value:this.state.seekProgress,onChange:function(t){return e._setTime(t.target.value,!0)}})),_react2["default"].createElement("div",{className:"r5-panel"},_react2["default"].createElement("button",{className:"r5-play",onClick:this._togglePlay},this.state.isPlaying?this.icons.pause:this.icons.play),_react2["default"].createElement("div",{className:"r5-volume"},_react2["default"].createElement("button",null,this.state.isMuted?this.icons.mute:this.state.volume>.7?this.icons.volumeUp:this.icons.volumeDown),_react2["default"].createElement("div",{className:"r5-volume-inner",style:{width:"80px"}},_react2["default"].createElement("div",{className:"r5-volume-bar",style:{width:100*this.state.volume+"%"}}),_react2["default"].createElement("input",{type:"range",min:"0",max:"1",step:"0.05",value:this.state.volume,onChange:function(t){return e._volume(t.target.value)}}))),_react2["default"].createElement("span",{className:"r5-timecode"},this.state.currentTime+" / "+this.state.duration),_react2["default"].createElement("div",{className:"r5-pull-right"},this.$subTitleMenu||this.$getSubtitleTracksMenu()||"",_react2["default"].createElement("button",{className:"r5-fullscreen",onClick:this._fullscreen},this.icons.fullscreen)))))}},{key:"componentWillMount",value:function(){this.state={isPlaying:this.props.autoPlay?!0:!1,isMuted:!1,currentTime:"00:00",duration:"00:00",loadedProgress:0,seekProgress:0,volume:this.props.volume,activeSubtitle:null};var e="#ffffff";this.icons={},this.icons.play=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M8 5v14l11-7z",fill:e}),_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),this.icons.pause=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z",fill:e}),_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),this.icons.playCircle=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),_react2["default"].createElement("path",{d:"M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z",fill:e})),this.icons.volumeUp=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z",fill:e}),_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),this.icons.volumeDown=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z",fill:e}),_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),this.icons.mute=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M7 9v6h4l5 5V4l-5 5H7z",fill:e}),_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"})),this.icons.subtitles=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),_react2["default"].createElement("path",{d:"M19 4H5c-1.11 0-2 .9-2 2v12c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 7H9.5v-.5h-2v3h2V13H11v1c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1zm7 0h-1.5v-.5h-2v3h2V13H18v1c0 .55-.45 1-1 1h-3c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1h3c.55 0 1 .45 1 1v1z",fill:e})),this.icons.fullscreen=_react2["default"].createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},_react2["default"].createElement("path",{d:"M0 0h24v24H0z",fill:"none"}),_react2["default"].createElement("path",{d:"M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z",fill:e}))}},{key:"componentWillUnmount",value:function(){this.seekbarUpdateTimer&&clearInterval(this.seekbarUpdateTimer)}}]),t}(_react2["default"].Component);Video.propTypes={metaDataLoaded:_react2["default"].PropTypes.func,sources:_react2["default"].PropTypes.array,subtitles:_react2["default"].PropTypes.array,autoPlay:_react2["default"].PropTypes.bool,controls:_react2["default"].PropTypes.bool,autoHideControls:_react2["default"].PropTypes.bool,controlPanelStyle:_react2["default"].PropTypes.oneOf(["overlay","fixed"]),preload:_react2["default"].PropTypes.oneOf(["auto","none","metadata"]),loop:_react2["default"].PropTypes.bool,mute:_react2["default"].PropTypes.bool,poster:_react2["default"].PropTypes.string,width:_react2["default"].PropTypes.string,height:_react2["default"].PropTypes.string,volume:_react2["default"].PropTypes.number},Video.defaultProps={autoPlay:!1,loop:!1,controls:!0,autoHideControls:!0,volume:1,mute:!1,controlPanelStyle:"overlay",preload:"auto"},exports["default"]=Video,module.exports=exports["default"];